<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ÖNBELLEK ENGELLEME (KULLANICILARIN ESKİ SÜRÜMÜ GÖRMEMESİ İÇİN) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <!-- FAVICON (Mavi Kalkan üzerinde Beyaz Kilit) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'><path fill-rule='evenodd' d='M10 1.944c1.964 0 3.74.786 5.037 2.083l.963-.963a.75.75 0 011.06 1.06l-.962.963A6.96 6.96 0 0117 10c0 3.866-3.134 7-7 7s-7-3.134-7-7c0-1.933.786-3.74 2.083-5.037l-.963-.963a.75.75 0 011.06-1.06l.963.963A6.96 6.96 0 0110 1.944zM8 10.5a.75.75 0 01.75-.75h2.5a.75.75 0 010 1.5h-2.5a.75.75 0 01-.75-.75zm.75 2.25a.75.75 0 000 1.5h2.5a.75.75 0 000-1.5h-2.5z' fill='white' clip-rule='evenodd'/><path d='M3 10c0 3.866 3.134 7 7 7s7-3.134 7-7c0-1.933-.786-3.74-2.083-5.037l-.963.963a5.48 5.48 0 01-1.017 3.324.75.75 0 00.316 1.06l.963.963c.293.293.293.768 0 1.06-.293.293-.768.293-1.06 0l-.963-.963a.75.75 0 00-1.06-.316 5.48 5.48 0 01-3.324 1.017l-.963.963c-.293.293-.768.293-1.06 0-.293-.293-.293-.768 0-1.06l.963-.963a.75.75 0 00.316-1.06 5.48 5.48 0 01-1.017-3.324l-.963-.963c-.293-.293-.293-.768 0-1.06.293-.293.768-.293 1.06 0l.963.963A6.96 6.96 0 013 10z' fill='%232563EB'/><path fill-rule='evenodd' d='M10 3.444c1.964 0 3.74.786 5.037 2.083l.963-.963a.75.75 0 011.06 1.06l-.962.963A6.96 6.96 0 0117 10c0 2.654-1.48 4.95-3.687 6.115l-.963-.963a.75.75 0 00-1.06.316 5.48 5.48 0 01-3.324 1.017v1.515a.75.75 0 01-1.5 0v-1.515a5.48 5.48 0 01-3.324-1.017.75.75 0 00-1.06-.316l-.963.963C4.48 14.95 3 12.654 3 10c0-1.933.786-3.74 2.083-5.037l-.963-.963a.75.75 0 011.06-1.06l.963.963A6.96 6.96 0 0110 3.444zM8.75 8a.75.75 0 00-1.5 0v3.5c0 .414.336.75.75.75h2.5a.75.75 0 000-1.5h-1.75V8z' fill='white' clip-rule='evenodd'/></svg>" type="image/svg+xml">
    
    <title>BSG Grup İçi Değerlendirme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase Modülleri
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // 'sessionAuthPersistence' ve 'setPersistence' GİRİŞ HATASI ÇÖZÜMÜ İÇİN EKLENDİ
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithRedirect, 
            getRedirectResult, 
            signOut,
            setPersistence,           // EKLENDİ (Oturum Düzeltmesi)
            sessionAuthPersistence  // EKLENDİ (Oturum Düzeltmesi)
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL DEĞİŞKENLER ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAGo1xQfMUvDMzcnWQLrTAA_zGTB_h96Jk",
            authDomain: "bsg-grup-ici-degerlendirme.firebaseapp.com",
            projectId: "bsg-grup-ici-degerlendirme",
            storageBucket: "bsg-grup-ici-degerlendirme.firebasestorage.app",
            messagingSenderId: "36504836557",
            appId: "1:36504836557:web:cda47796201a5c0e4d4c84"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let db, auth, provider;
        let allRatingsData = []; 
        let allTimeDataCache = {};
        let weekMapping = {}; 
        let availableWeeks = []; 
        
        let gCurrentRaterName = null; 
        let gCurrentUserEmail = null; 
        let isAuthReady = false;

        // Veri Yolları
        const RATING_COLLECTION_PATH = `artifacts/${appId}/public/data/ratings`;
        const USER_DIRECTORY_PATH = `user_directory`; 

        // Gruptaki Kişiler (Sadece Puanlama ve Tablolar için)
        const userList = [
            "Enes Malik Arı", "İbrahim Kerem Güven", "Oğuzhan Erdoğan", 
            "Özgün Deniz Sevilmiş", "Selanur Ayaz", "Semih Tepe", "Sena Ateş", 
            "Sude Demir", "Sudem Cücemen", "Şerif Bayram", "Uğur Berktaş"
        ].sort((a, b) => a.localeCompare(b, 'tr'));

        // Puanlama Kriterleri ve Ağırlıkları
        const criteria = [
            { id: "katilim", name: "Toplantıya Katılım", weight: 1 },
            { id: "zorunlu", name: "Zorunlu Görev", weight: 1.25 },
            { id: "ekstra", name: "Ekstra Görev", weight: 0.75 },
            { id: "yardim", name: "Görev Desteği", weight: 0.5 },
            { id: "bilgi", name: "Bilgi Paylaşımı", weight: 0.5 }
        ];
        const totalWeight = criteria.reduce((sum, c) => sum + c.weight, 0);

        // --- UTILITY FONKSİYONLARI ---

        function getCurrentWeekISO() {
            const date = new Date();
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            const weekNumber = 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            return `${date.getFullYear()}-W${weekNumber.toString().padStart(2, '0')}`;
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById("toast-notification");
            const toastMessage = document.getElementById("toast-message");
            toastMessage.textContent = message;
            if (isError) {
                toast.classList.replace("bg-green-500", "bg-red-500");
            } else {
                toast.classList.replace("bg-red-500", "bg-green-500");
            }
            toast.classList.remove("opacity-0", "-translate-y-12");
            toast.classList.add("opacity-100", "translate-y-0");
            setTimeout(() => {
                toast.classList.remove("opacity-100", "translate-y-0");
                toast.classList.add("opacity-0", "-translate-y-12");
            }, 3000);
        }

        function createWeekMapping(ratingDocs) {
            const weeks = new Set();
            ratingDocs.forEach(doc => {
                weeks.add(doc.data().week);
            });
            const currentWeek = getCurrentWeekISO();
            weeks.add(currentWeek);
            availableWeeks = Array.from(weeks).sort();
            weekMapping = {};
            availableWeeks.forEach((week, index) => {
                weekMapping[week] = `${index + 1}. Hafta`;
            });
            const currentWeekLabel = document.getElementById("current-week-label");
            if (currentWeekLabel) {
                currentWeekLabel.textContent = weekMapping[currentWeek] || "Hafta Etiketi Yok";
            }
        }

        // --- ANA VERİ İŞLEME MANTIĞI ---

        function processData(ratingDocs) {
            const ratingsByWeek = {};
            ratingDocs.forEach(doc => {
                const data = doc.data();
                if (!ratingsByWeek[data.week]) {
                    ratingsByWeek[data.week] = [];
                }
                ratingsByWeek[data.week].push(data);
            });

            const allTimeData = {};
            userList.forEach(name => {
                allTimeData[name] = {
                    name: name,
                    weeklyScores: [],
                    averageScore: 0
                };
            });

            for (const week in weekMapping) {
                const submissions = ratingsByWeek[week] || [];
                const scoresReceivedThisWeek = {};
                userList.forEach(name => {
                    scoresReceivedThisWeek[name] = [];
                });

                submissions.forEach(submission => {
                    for (const targetName in submission.ratings) {
                        if (scoresReceivedThisWeek[targetName]) {
                            const scores = submission.ratings[targetName];
                            let weightedSum = 0;
                            criteria.forEach(c => {
                                weightedSum += (scores[c.id] || 0) * c.weight;
                            });
                            const score_100 = weightedSum * (100 / totalWeight);
                            scoresReceivedThisWeek[targetName].push(score_100);
                        }
                    }
                });

                userList.forEach(name => {
                    const received = scoresReceivedThisWeek[name];
                    let finalWeekScore = 0;
                    if (received.length > 0) {
                        const total = received.reduce((a, b) => a + b, 0);
                        finalWeekScore = total / received.length;
                    }
                    allTimeData[name].weeklyScores.push({ week: week, score: finalWeekScore });
                });
            }

            userList.forEach(name => {
                const validScores = allTimeData[name].weeklyScores.filter(s => ratingsByWeek[s.week]);
                if (validScores.length > 0) {
                    const total = validScores.reduce((sum, s) => sum + s.score, 0);
                    allTimeData[name].averageScore = total / validScores.length;
                } else {
                     allTimeData[name].averageScore = 0;
                }
            });

            allTimeDataCache = allTimeData;
            return allTimeData;
        }

        // --- ARAYÜZ GÜNCELLEME (RENDER) FONKSİYONLARI ---

        async function renderRatingForm() {
            if (!gCurrentRaterName) { 
                document.getElementById("rating-form-container").classList.add("hidden");
                return;
            }

            const formContainer = document.getElementById("rating-form-container");
            const formTableBody = document.getElementById("rating-form-table-body");
            const submitButton = document.getElementById("submit-button");
            
            formTableBody.innerHTML = "";
            formContainer.classList.remove("hidden");
            submitButton.disabled = false;
            
            const currentWeek = getCurrentWeekISO();
            const docId = `rating_${currentWeek}_by_${gCurrentRaterName.replace(/\s+/g, '_')}`;
            const docRef = doc(db, RATING_COLLECTION_PATH, docId);
            const docSnap = await getDoc(docRef);
            
            const previousRatings = docSnap.exists() ? docSnap.data().ratings : {};

            userList.forEach(targetName => {
                if (targetName === gCurrentRaterName) return; 

                const tr = document.createElement("tr");
                tr.className = "border-b border-gray-200";

                const tdName = document.createElement("td");
                tdName.className = "py-3 px-2 text-sm font-medium text-gray-800";
                tdName.textContent = targetName;
                tr.appendChild(tdName);
                
                const targetPreviousScores = previousRatings[targetName] || {};

                criteria.forEach(c => {
                    const tdCrit = document.createElement("td");
                    tdCrit.className = "py-3 px-2";
                    const fieldId = `rating-${targetName.replace(/\s+/g, '-')}-${c.id}`;
                    
                    const prevScore = targetPreviousScores[c.id] !== undefined ? targetPreviousScores[c.id] : 0;
                    
                    const isPlus = prevScore === 1 ? "checked" : "";
                    const isZero = prevScore === 0 ? "checked" : "";
                    const isMinus = prevScore === -1 ? "checked" : "";
                    
                    tdCrit.innerHTML = `
                        <div class="flex items-center justify-center space-x-1">
                            <input type="radio" id="${fieldId}-plus" name="${fieldId}" value="1" class="hidden peer/plus" ${isPlus}>
                            <label for="${fieldId}-plus" class="w-6 h-6 flex items-center justify-center rounded-full cursor-pointer text-sm font-bold text-green-800 bg-green-200 hover:bg-green-300 peer-checked/plus:bg-green-600 peer-checked/plus:text-white transition-all">+</label>
                            
                            <input type="radio" id="${fieldId}-zero" name="${fieldId}" value="0" class="hidden peer/zero" ${isZero}>
                            <label for="${fieldId}-zero" class="w-6 h-6 flex items-center justify-center rounded-full cursor-pointer text-sm font-bold text-gray-800 bg-gray-200 hover:bg-gray-300 peer-checked/zero:bg-gray-500 peer-checked/zero:text-white transition-all">~</label>
                            
                            <input type="radio" id="${fieldId}-minus" name="${fieldId}" value="-1" class="hidden peer/minus" ${isMinus}>
                            <label for="${fieldId}-minus" class="w-6 h-6 flex items-center justify-center rounded-full cursor-pointer text-sm font-bold text-red-800 bg-red-200 hover:bg-red-300 peer-checked/minus:bg-red-600 peer-checked/minus:text-white transition-all">-</label>
                        </div>
                    `;
                    tr.appendChild(tdCrit);
                });

                formTableBody.appendChild(tr);
            });
        }

        function renderResultsTable(allTimeData, selectedWeekISO) {
            const tableBody = document.getElementById("results-table-body");
            tableBody.innerHTML = "";
            userList.forEach(name => {
                const userData = allTimeData[name];
                if (!userData) return;
                const selectedWeekData = userData.weeklyScores.find(s => s.week === selectedWeekISO);
                const selectedWeekScore = selectedWeekData ? selectedWeekData.score : 0;
                const averageScore = userData.averageScore;
                const tr = document.createElement("tr");
                tr.className = "border-b border-gray-200 hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="py-3 px-4 text-sm font-medium text-gray-900">${name}</td>
                    <td class="py-3 px-4 text-sm text-gray-700 text-center">${selectedWeekScore.toFixed(2)}</td>
                    <td class="py-3 px-4 text-sm text-gray-700 text-center font-semibold ${averageScore > 0 ? 'text-blue-600' : (averageScore < 0 ? 'text-red-600' : 'text-gray-700')}">
                        ${averageScore.toFixed(2)}
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function renderStarTables(allTimeData, selectedWeekISO) {
            const weekStarsList = document.getElementById("week-stars-list");
            const allTimeStarsList = document.getElementById("all-time-stars-list");
            weekStarsList.innerHTML = "";
            allTimeStarsList.innerHTML = "";

            const weeklyScores = userList.map(name => {
                const userData = allTimeData[name];
                const selectedWeekData = userData.weeklyScores.find(s => s.week === selectedWeekISO);
                return { name: name, score: selectedWeekData ? selectedWeekData.score : 0 };
            });
            const maxWeeklyScore = Math.max(...weeklyScores.map(u => u.score));
            const haftaninYildizlari = weeklyScores
                .filter(u => u.score === maxWeeklyScore && u.score > 0)
                .sort((a, b) => a.name.localeCompare(b.name, 'tr'));

             const averageScores = userList.map(name => {
                return { name: name, score: allTimeData[name].averageScore };
            });
            const maxAverageScore = Math.max(...averageScores.map(u => u.score));
            const projeninYildizlari = averageScores
                .filter(u => u.score === maxAverageScore && u.score > 0)
                .sort((a, b) => a.name.localeCompare(b.name, 'tr'));
            
            const populateList = (listEl, stars, placeholder) => {
                if (stars.length === 0) {
                    listEl.innerHTML = `<li class="text-sm text-gray-500 italic px-3 py-2">${placeholder}</li>`;
                } else {
                    stars.forEach(star => {
                        listEl.innerHTML += `
                            <li class="flex items-center justify-between px-3 py-2 bg-white/50 rounded-md mb-1">
                                <span class="font-medium text-gray-800">${star.name}</span>
                                <span class="font-bold text-yellow-600">${star.score.toFixed(2)}</span>
                            </li>
                        `;
                    });
                }
                const remaining = 11 - stars.length;
                for(let i=0; i < remaining && stars.length > 0; i++) {
                     listEl.innerHTML += `<li class="px-3 py-2 h-9 mb-1"></li>`;
                }
            };
            populateList(weekStarsList, haftaninYildizlari, "Bu hafta henüz yıldız yok.");
            populateList(allTimeStarsList, projeninYildizlari, "Genel sıralamada henüz yıldız yok.");
        }
        
        function renderWeekSelector() {
            const selector = document.getElementById("week-selector");
            selector.innerHTML = "";
            const currentWeek = getCurrentWeekISO();
            const reversedWeeks = [...availableWeeks].reverse();
            reversedWeeks.forEach(weekISO => {
                const option = document.createElement("option");
                option.value = weekISO;
                option.textContent = weekMapping[weekISO] || weekISO;
                if(weekISO === currentWeek) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            selector.removeEventListener("change", handleWeekChange);
            selector.addEventListener("change", handleWeekChange);
        }
        
        function handleWeekChange() {
            const selectedWeekISO = document.getElementById("week-selector").value;
            if (!selectedWeekISO) return;
            renderResultsTable(allTimeDataCache, selectedWeekISO);
            renderStarTables(allTimeDataCache, selectedWeekISO);
        }
        
        function updateUIAfterAuth(userName) {
            const authButton = document.getElementById("auth-button");
            const authStatus = document.getElementById("auth-status");
            
            if(userName) {
                gCurrentRaterName = userName;
                authButton.textContent = "Çıkış Yap";
                authStatus.innerHTML = `Hoş geldiniz, <span class="font-bold">${userName}</span>`;
                authStatus.classList.remove("hidden");
                renderRatingForm(); 
            } else {
                gCurrentRaterName = null;
                gCurrentUserEmail = null;
                authButton.textContent = "Google ile Giriş Yap";
                authStatus.classList.add("hidden");
                document.getElementById("rating-form-container").classList.add("hidden"); 
            }
        }

        async function checkUserAuthorization(email) {
            try {
                const userDocRef = doc(db, USER_DIRECTORY_PATH, email.toLowerCase());
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const matchedName = userDocSnap.data().name;
                    gCurrentUserEmail = email;
                    updateUIAfterAuth(matchedName);
                } else {
                    showToast(`Bu e-posta (${email}) yetkili değil.`, true);
                    signOut(auth);
                    updateUIAfterAuth(null);
                }
            } catch (error) {
                console.error("Yetki kontrolü hatası:", error);
                showToast("Giriş yapılırken yetki kontrol edilemedi.", true);
                signOut(auth);
                updateUIAfterAuth(null);
            }
        }


        // --- EVENT HANDLERS ---
        
        async function handleAuthClick() {
            if (gCurrentRaterName) {
                // Kullanıcı zaten giriş yapmış, ÇIKIŞ YAP
                await signOut(auth);
                showToast("Başarıyla çıkış yapıldı.");
            } else {
                // Kullanıcı giriş yapmamış, GİRİŞ YAP
                try {
                    // *** GİRİŞ HATASI DÜZELTMESİ (Persistence) ***
                    // Tarayıcının yönlendirme sonrası girişi hatırlaması için
                    // depolamayı 'session' (oturum) olarak ayarla.
                    await setPersistence(auth, sessionAuthPersistence); 
                    // Yönlendirmeyi başlat
                    await signInWithRedirect(auth, provider); 
                } catch (error) {
                    console.error("Google yönlendirmesi sırasında hata:", error);
                    showToast("Google'a yönlendirilirken bir hata oluştu.", true);
                }
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            if (!gCurrentRaterName) {
                showToast("Puanlama gönderebilmek için giriş yapmalısınız.", true);
                return;
            }
            
            const submitButton = document.getElementById("submit-button");
            submitButton.disabled = true;
            submitButton.textContent = "Gönderiliyor...";

            try {
                const currentWeek = getCurrentWeekISO();
                const ratings = {};
                
                userList.forEach(targetName => {
                    if (targetName === gCurrentRaterName) return;
                    const targetRatings = {};
                    let formIsValid = true;
                    
                    criteria.forEach(c => {
                        const fieldId = `rating-${targetName.replace(/\s+/g, '-')}-${c.id}`;
                        const checkedInput = document.querySelector(`input[name="${fieldId}"]:checked`);
                        if (checkedInput) {
                            targetRatings[c.id] = parseInt(checkedInput.value, 10);
                        } else {
                            formIsValid = false;
                        }
                    });

                    if (formIsValid) {
                        ratings[targetName] = targetRatings;
                    }
                });

                const docId = `rating_${currentWeek}_by_${gCurrentRaterName.replace(/\s+/g, '_')}`;
                const payload = {
                    rater: gCurrentRaterName,
                    week: currentWeek,
                    ratings: ratings,
                    submittedAt: new Date().toISOString()
                };

                const docRef = doc(db, RATING_COLLECTION_PATH, docId);
                await setDoc(docRef, payload);

                showToast("Puanlama başarıyla gönderildi!");
                
            } catch (error) {
                console.error("Puanlama gönderilirken hata:", error);
                showToast("Bir hata oluştu: " + error.message, true);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "Puanlamayı Gönder";
            }
        }
        
        function toggleHelpModal(show) {
            const modal = document.getElementById("help-modal");
            const modalBackdrop = document.getElementById("modal-backdrop");
            if (show) {
                modal.classList.remove("hidden");
                modalBackdrop.classList.remove("hidden");
            } else {
                modal.classList.add("hidden");
                modalBackdrop.classList.add("hidden");
            }
        }
        
        function handleModalClick(e) {
            if (e.target.id === "help-modal") {
                toggleHelpModal(false);
            }
        }

        // --- UYGULAMA BAŞLANGICI (Zamanlama Hatası Düzeltildi) ---

        async function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                provider = new GoogleAuthProvider();
                
                // 1. Tüm Buton Dinleyicilerini Kur
                document.getElementById("rating-form").addEventListener("submit", handleSubmit);
                document.getElementById("auth-button").addEventListener("click", handleAuthClick);
                document.getElementById("show-help-button").addEventListener("click", () => toggleHelpModal(true));
                document.getElementById("modal-close-button").addEventListener("click", () => toggleHelpModal(false));
                document.getElementById("help-modal").addEventListener("click", handleModalClick);
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !document.getElementById("help-modal").classList.contains("hidden")) {
                        toggleHelpModal(false);
                    }
                });

                // 2. Auth Durumunu YÖNETEN ANA FONKSİYON
                // Bu fonksiyon, hem yönlendirmeden (redirect) dönüşü
                // hem de normal sayfa ziyaretlerini (zaten giriş yapmış) yakalar.
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true; // Auth durumu kontrol edildi
                    if (user && user.email) {
                        // Kullanıcı giriş yaptı. Yetkisini kontrol et.
                        checkUserAuthorization(user.email);
                    } else {
                        // Kullanıcı giriş yapmamış.
                        updateUIAfterAuth(null);
                    }
                });

                // 3. YÖNLENDİRME (REDIRECT) SONUCUNU KONTROL ET
                // Sayfa yüklendiğinde, Google'dan bir yönlendirme olup olmadığını
                // kontrol et. Bu, onAuthStateChanged'i tetikleyecektir.
                try {
                    // 'isAuthReady' (yukarıda) 'true' olana kadar
                    // 'getRedirectResult' beklemeyecek.
                    await getRedirectResult(auth);
                    // Bu fonksiyonun 'result'ını kullanmamıza gerek yok,
                    // çünkü onAuthStateChanged (yukarıda) tüm işi yapacak.
                } catch (error) {
                    console.error("Giriş yönlendirmesi hatası:", error);
                    showToast("Giriş yapılırken bir hata oluştu: " + error.code, true);
                    updateUIAfterAuth(null);
                }
                
                // 4. Veritabanını DİNLE (Herkes için)
                subscribeToRatings(); 

            } catch (error) {
                console.error("Uygulama başlatılırken hata:", error);
                document.body.innerHTML = `<div class="p-8 text-red-600">Uygulama yüklenirken kritik bir hata oluştu: ${error.message}</div>`;
            }
        }

        // Subscribe to Firestore changes
        function subscribeToRatings() {
            const q = collection(db, RATING_COLLECTION_PATH);
            
            document.getElementById("loading-indicator").classList.remove("hidden");
            document.getElementById("results-content").classList.add("hidden");

            onSnapshot(q, (snapshot) => {
                allRatingsData = snapshot.docs;
                createWeekMapping(allRatingsData);
                const allTimeData = processData(allRatingsData);
                renderWeekSelector();
                
                const selectedWeekISO = document.getElementById("week-selector").value;
                if(selectedWeekISO) { 
                    renderResultsTable(allTimeData, selectedWeekISO);
                    renderStarTables(allTimeData, selectedWeekISO);
                }
                
                document.getElementById("loading-indicator").classList.add("hidden");
                document.getElementById("results-content").classList.remove("hidden");

            }, (error) => {
                console.error("Firestore dinleyicisinde hata:", error);
                showToast("Veriler yüklenirken bir hata oluştu.", true);
                document.getElementById("loading-indicator").textContent = "Veri yüklenemedi.";
            });
        }

        document.addEventListener("DOMContentLoaded", initApp);
    </script>
    
    <style>
        /* CSS to clean up browser focus/tap highlighting */
        input[type="radio"].hidden:focus + label {
            outline: 2px solid transparent;
            outline-offset: 2px;
        }
        input[type="radio"].hidden:focus-visible + label {
            outline: none;
            box-shadow: none;
        }
        label, button {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans antialiased">

    <!-- Ana Konteyner -->
    <div class="container mx-auto max-w-7xl my-8 p-4">
    
        <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-6 rounded-t-lg shadow-md relative">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold">BSG Grup İçi Değerlendirme</h1>
                    <p class="text-sm text-blue-100">Haftalık performans ve katkı değerlendirme formu.</p>
                </div>
                <!-- Nasıl Kullanılır Butonu -->
                <button id="show-help-button" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-2 px-4 rounded-lg transition-all">
                    Nasıl Kullanılır?
                </button>
            </div>
        </header>

        <div class="bg-white shadow-lg rounded-b-lg flex flex-col lg:flex-row">

            <!-- Sol Taraf: Puanlama Formu -->
            <div class="w-full lg:w-1/2 p-4 sm:p-6 border-b lg:border-b-0 lg:border-r border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Değerlendirme Formu</h2>
                
                <!-- GİRİŞ/ÇIKIŞ BÖLÜMÜ -->
                <div id="rater-selection-div" class="mb-4 space-y-3">
                    <p class="text-gray-700">Puanlama yapmak için lütfen giriş yapınız.</p>
                    <button id="auth-button" class="w-full flex items-center justify-center gap-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition duration-300">
                        Google ile Giriş Yap
                    </button>
                    <p id="auth-status" class="text-center text-green-700 bg-green-100 p-2 rounded-md hidden"></p>
                </div>

                <!-- Puanlama Formu Konteyneri (Giriş yapınca görünür) -->
                <div id="rating-form-container" class="hidden">
                    <div class="flex justify-between items-center mb-3">
                         <h3 class="text-lg font-medium text-gray-700">Puanlama Tablosu</h3>
                         <span class="text-sm font-semibold text-blue-600 bg-blue-100 px-3 py-1 rounded-full" id="current-week-label">...</span>
                    </div>
                   
                    <form id="rating-form">
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kişi</th>
                                        <th class="py-3 px-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="Toplantıya Katılım (1)">Toplantıya Katılım</th>
                                        <th class="py-3 px-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="Zorunlu Görev (1.25)">Zorunlu Görev</th>
                                        <th class="py-3 px-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="Ekstra Görev (0.75)">Ekstra Görev</th>
                                        <th class="py-3 px-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="Görev Desteği (0.5)">Görev Desteği</th>
                                        <th class="py-3 px-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="Bilgi Paylaşımı (0.5)">Bilgi Paylaşımı</th>
                                    </tr>
                                </thead>
                                <tbody id="rating-form-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Form satırları JS ile eklenecek -->
                                </tbody>
                            </table>
                        </div>
                        <button type="submit" id="submit-button" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                            Puanlamayı Gönder
                        </button>
                    </form>
                </div>
            </div>

            <!-- Sağ Taraf: Sonuçlar ve Tablolar (Her zaman görünür) -->
            <div class="w-full lg:w-1/2 p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Sonuçlar ve Puan Durumu</h2>
                    <div class="flex items-center">
                        <label for="week-selector" class="block text-sm font-medium text-gray-700 mr-2">Hafta:</label>
                        <select id="week-selector" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <!-- Haftalar JS ile eklenecek -->
                        </select>
                    </div>
                </div>

                <div id="loading-indicator" class="flex items-center justify-center h-64">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-lg text-gray-600">Sonuçlar yükleniyor...</span>
                </div>

                <div id="results-content" class="hidden">
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Haftalık Puan Durumu</h3>
                        <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kişi</th>
                                        <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Seçilen Hafta Puanı</th>
                                        <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Genel Ortalama</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Sonuç satırları JS ile eklenecek -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 shadow-sm">
                            <h4 class="text-lg font-semibold text-yellow-800 mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                Haftanın Yıldızı
                            </h4>
                            <ul id="week-stars-list" class="space-y-1">
                                <!-- JS ile doldurulacak -->
                            </ul>
                        </div>
                        
                        <div class="bg-purple-50 border border-purple-300 rounded-lg p-4 shadow-sm">
                            <h4 class="text-lg font-semibold text-purple-800 mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2">
                                    <path fill-rule="evenodd" d="M14.615 1.595a.75.75 0 01.359.852L12.982 9.75h7.268a.75.75 0 01.548 1.262l-10.5 11.25a.75.75 0 01-1.272-.71l1.983-7.319H3.75a.75.75 0 01-.548-1.262l10.5-11.25a.75.75 0 01.913-.143z" clip-rule="evenodd" />
                                </svg>
                                Projenin Yıldızı
                            </h4>
                            <ul id="all-time-stars-list" class="space-y-1">
                                <!-- JS ile doldurulacak -->
                            </ul>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Bildirim -->
    <div id="toast-notification" class="fixed top-5 right-5 w-auto max-w-sm p-4 bg-green-500 text-white rounded-lg shadow-lg opacity-0 -translate-y-12 transform transition-all duration-300 ease-in-out z-50">
        <p id="toast-message" class="font-medium">Puanlama başarıyla gönderildi!</p>
    </div>
    
    <!-- Nasıl Kullanılır? Modal (Pencere) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/30 backdrop-blur-sm hidden z-40" aria-hidden="true"></div>
    <div id="help-modal" class="fixed inset-0 z-50 flex justify-center p-4 hidden overflow-y-auto" onclick="handleModalClick(event)">
        
        <div class="bg-white w-full max-w-2xl rounded-lg shadow-2xl p-6 relative my-8 h-fit" onclick="event.stopPropagation()">
            
            <button id="modal-close-button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Nasıl Kullanılır?</h3>
            
            <div class="space-y-4 text-gray-700">
                <div>
                    <h4 class="font-semibold text-lg">1. Başlama:</h4>
                    <p>Puanlama formunu açmak için, ana sayfadaki <strong>"Google ile Giriş Yap"</strong> butonunu kullanarak ekibe kayıtlı e-posta adresinizle giriş yapınız.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg">2. Puanlama:</h4>
                    <p>Değerlendirmeyi <code class="bg-gray-100 px-1 py-0.5 rounded">+</code>, <code class="bg-gray-100 px-1 py-0.5 rounded">~</code>, <code class="bg-gray-100 px-1 py-0.5 rounded">-</code> butonları ile yapınız.</p>
                    <ul class="list-disc list-inside mt-2 ml-4 space-y-1">
                        <li><code class="font-bold text-green-600">+</code>: Olumlu katkı (Görev tamamlandı).</li>
                        <li><code class="font-bold text-red-600">-</code>: Olumsuz katkı (Görev aksatıldı).</li>
                        <li><code class="font-bold text-gray-600">~</code>: Nötr (Görev yarım yapıldı / Bilgim yok).</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-lg">3. Gönderme:</h4>
                    <p>"Puanlamayı Gönder" butonuna basıp "Puanlama başarıyla gönderildi!" bildirimini gördüğünüzden emin olunuz. Sistem, puanları kriter ağırlıklarına göre hesaplar ve 100'lük sisteme çevirip tabloya işler.</p>
                </div>
                 <div>
                    <h4 class="font-semibold text-lg">4. Güncelleme:</h4>
                    <p>Sistem, giriş yaptığınızda o hafta için daha önce verdiğiniz puanları forma geri yükler. Hafta içinde puanlarınızı değiştirebilirsiniz; sistem her zaman son gönderdiğiniz puanın üzerine yazar.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg">5. Zamanlama:</h4>
                    <p>Puanlamalar haftalıktır ve Herkesi aynı anda puanlamak zorunda değilsiniz, hafta içinde parçalı puanlama yapabilirsiniz. Puanlamalar <strong>her hafta pazar akşamına kadar</strong> tamamlanmalıdır.</p>
                </div>
                 <div>
                    <h4 class="font-semibold text-lg">6. Geçmiş:</h4>
                    <p>"Sonuçlar" panelindeki "Hafta" menüsünden sonucunu görüntülemek istediğiniz haftayı seçerek geçmiş puanları ve yıldızları görüntüleyebilirsiniz.</p>
                </div>
            </div>
            
        </div>
    </div>

</body>
</html>